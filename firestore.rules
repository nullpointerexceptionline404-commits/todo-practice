rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    function isSelf(uid) {
      return signedIn() && request.auth.uid == uid;
    }

    function onlyTodoKeys(data) {
      // 余計なフィールド混入を防ぐ（必要があればここに追加）
      return data.keys().hasOnly([
        'content',
        'done',
      ]);
    }

    function validContent(data) {
      return data.content is string
        && data.content.size() >= 1
        && data.content.size() <= 200
        // 空白だけ禁止（半角/全角を想定）
        && data.content.matches('.*[^ 　].*')
        // 先頭が空白（半角/全角）ならNG
        && !data.content.matches('^[ 　].*')
        // 末尾が空白（半角/全角）ならNG
        && !data.content.matches('.*[ 　]$');
    }

    function validDone(data) {
      return data.done is bool;
    }

    match /users/{uid} {
      allow read, write: if false;

      match /todos/{todoId} {
        // 本人のサブコレクションのみ読み取り
        allow get, list: if isSelf(uid);

        allow create: if isSelf(uid)
          && onlyTodoKeys(request.resource.data)
          && validContent(request.resource.data)
          && validDone(request.resource.data);

        allow update: if isSelf(uid)
          && onlyTodoKeys(request.resource.data)
          && validContent(request.resource.data)
          && validDone(request.resource.data);

        // 削除：本人のみ
        allow delete: if isSelf(uid);
      }
    }
  }
}